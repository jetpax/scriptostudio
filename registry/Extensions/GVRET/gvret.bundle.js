// === EXTENSION_BUNDLE ===
// Generated by bundle_extensions.js
// Do not edit - regenerated on each build
// BUILD_ID: 2026-02-11T19-25-20

console.log('%c[GVRET] BUILD 2026-02-11T19-25-20', 'color: #ff8c00; font-weight: bold');

export const __EXTENSION_META__ = {
  "name": "GVRET",
  "id": "gvret",
  "version": [
    1,
    3,
    0
  ],
  "author": "JetPax",
  "description": "High-performance GVRET implementation for MicroPython. Enables SavvyCAN connection over TCP/IP (mpDirect) for vehicle network analysis.",
  "icon": "radio",
  "iconSvg": "<svg xmlns=\"http://www.w3.org/2000/svg\" class=\"icon icon-tabler icon-tabler-topology-bus\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" stroke-width=\"2\" stroke=\"currentColor\" fill=\"none\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path stroke=\"none\" d=\"M0 0h24v24H0z\" fill=\"none\"/><path d=\"M14 10a2 2 0 1 0 -4 0a2 2 0 0 0 4 0z\" /><path d=\"M6 10a2 2 0 1 0 -4 0a2 2 0 0 0 4 0z\" /><path d=\"M22 10a2 2 0 1 0 -4 0a2 2 0 0 0 4 0z\" /><path d=\"M2 16h20\" /><path d=\"M4 12v4\" /><path d=\"M12 12v4\" /><path d=\"M20 12v4\" /></svg>",
  "menu": [
    {
      "id": "connection",
      "label": "Connection"
    },
    {
      "id": "filters",
      "label": "Filters"
    }
  ],
  "styles": ".gvret-container { padding: 20px; } .gvret-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; margin-bottom: 20px; } .gvret-card h3 { margin-top: 0; margin-bottom: 16px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; } .gvret-form-row { display: flex; gap: 16px; margin-bottom: 12px; align-items: center; } .gvret-form-row label { width: 100px; } .gvret-input { padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); } .gvret-btn { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; } .gvret-btn-primary { background: var(--scheme-primary); color: white; } .gvret-btn-danger { background: #ef4444; color: white; } .gvret-filter-list { display: flex; flex-direction: column; gap: 8px; } .gvret-filter-item { display: flex; gap: 12px; padding: 8px; background: var(--bg-primary); border-radius: 4px; align-items: center; } .gvret-stat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px; } .gvret-stat-card { background: var(--bg-primary); padding: 12px; border-radius: 4px; text-align: center; } .gvret-stat-value { font-size: 24px; font-weight: bold; color: var(--scheme-primary); } .gvret-stat-label { font-size: 12px; color: var(--text-secondary); }"
};

export const __DEVICE_FILES__ = {};

// Bundled extension code
var i=class{constructor(t,e,s,r){this.device=t,this.emit=e,this.state=s,this.html=r,this.statsInterval=null,this.state.gvret||(this.state.gvret={isRunning:!1,filters:[],stats:{rx:0,tx:0,dropped:0}})}renderConnection(){let t=this.state.gvret;return this.html`
      <div class="gvret-container">
        <div class="gvret-card">
          <h3>GVRET Configuration</h3>
          
          <div class="gvret-form-row" style="margin-top: 20px;">
            ${t.isRunning?this.html`
              <button class="gvret-btn gvret-btn-danger" onclick=${()=>this.stopGVRET()}>
                Stop GVRET
              </button>
            `:this.html`
              <button class="gvret-btn gvret-btn-primary" onclick=${()=>this.startGVRET()}>
                Start GVRET
              </button>
            `}
          </div>
          
          <div style="margin-top: 16px; font-size: 14px; color: var(--text-secondary);">
            <p>Status: <strong>${t.isRunning?"Running (Port 23)":"Stopped"}</strong></p>
            ${t.isRunning?this.html`<p>Connect SavvyCAN to IP: <strong>${this.device.ip||"Device IP"}</strong> Port: <strong>23</strong></p>`:""}
            <p style="margin-top: 8px; font-size: 12px;">Using system CAN configuration (pins and bitrate configured in Networks â†’ CAN)</p>
          </div>
        </div>

        <div class="gvret-card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
             <h3>Statistics</h3>
             <button class="gvret-btn" onclick=${()=>this.refreshStats()}>Refresh</button>
          </div>
         
          <div class="gvret-stat-grid">
            <div class="gvret-stat-card">
              <div class="gvret-stat-value">${t.stats.rx}</div>
              <div class="gvret-stat-label">RX Frames</div>
            </div>
            <div class="gvret-stat-card">
              <div class="gvret-stat-value">${t.stats.tx}</div>
              <div class="gvret-stat-label">TX Frames</div>
            </div>
            <div class="gvret-stat-card">
              <div class="gvret-stat-value">${t.stats.dropped}</div>
              <div class="gvret-stat-label">Dropped</div>
            </div>
          </div>
        </div>
      </div>
    `}renderFilters(){let t=this.state.gvret;return this.html`
      <div class="gvret-container">
        <div class="gvret-card">
          <h3>Add Filter</h3>
          <div class="gvret-form-row">
            <input type="text" class="gvret-input" placeholder="ID (hex)" id="filter-id-input" />
            <input type="text" class="gvret-input" placeholder="Mask (hex)" value="7FF" id="filter-mask-input" />
            <label style="width: auto;">
              <input type="checkbox" id="filter-ext-input" /> Ext
            </label>
            <button class="gvret-btn gvret-btn-primary" onclick=${()=>this.addFilterUI()}>Add</button>
          </div>
        </div>

        <div class="gvret-card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3 style="margin: 0; border: none;">Active Filters</h3>
            <button class="gvret-btn gvret-btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick=${()=>this.clearFilters()}>Clear All</button>
          </div>
          
          <div class="gvret-filter-list">
            ${t.filters.length===0?this.html`<div style="color: var(--text-secondary); font-style: italic;">No filters active (Accept All)</div>`:""}
            ${t.filters.map((e,s)=>this.html`
              <div class="gvret-filter-item">
                <div style="font-family: monospace; font-weight: bold;">ID: 0x${e.id.toString(16).toUpperCase()}</div>
                <div style="font-family: monospace; color: var(--text-secondary);">Mask: 0x${e.mask.toString(16).toUpperCase()}</div>
                <div style="font-size: 12px; background: ${e.extended?"#3b82f6":"#10b981"}; color: white; padding: 2px 6px; border-radius: 4px;">${e.extended?"EXT":"STD"}</div>
              </div>
            `)}
          </div>
        </div>
      </div>
    `}async startGVRET(){let t=this.state.gvret;try{let e=await this.device.execute(`
from lib.sys import board, settings
import gvret
import json
import twai

# Check if already running
try:
    bitrate = gvret.get_bitrate()
    if bitrate > 0:
        print(json.dumps({'success': True, 'status': 'already_running'}))
    else:
        raise ValueError('Not running')
except:
    # Not running, proceed with start
    # Get CAN pins from board configuration
    if not board.has('can'):
        print(json.dumps({'success': False, 'error': 'Board has no CAN capability'}))
    else:
        can_bus = board.can('twai')  # or 'can0' depending on board definition
        if can_bus is None:
            print(json.dumps({'success': False, 'error': 'CAN bus not defined in board.json'}))
        else:
            tx_pin = can_bus.tx
            rx_pin = can_bus.rx
            bitrate = settings.get('can.bitrate', 500000)
            
            def on_bitrate_change(new_bitrate):
                twai.deinit()
                twai.init(tx=tx_pin, rx=rx_pin, baudrate=new_bitrate)
            
            gvret.set_bitrate_change_callback(on_bitrate_change)
            
            if gvret.start(tx_pin, rx_pin, bitrate):
                print(json.dumps({'success': True, 'status': 'started'}))
            else:
                print(json.dumps({'success': False, 'error': 'gvret.start() returned False'}))
      `);if(!e||!e.success){let s=e?.error||"Unknown error";console.error("[GVRET] Start failed:",e),alert(`Failed to start GVRET: ${s}`);return}t.isRunning=!0,t.stats={rx:0,tx:0,dropped:0},this.emit("render"),t.filters.length>0&&await this.applyFilters(),this.startStatsRefresh()}catch(e){console.error("[GVRET] Exception:",e),alert("Failed to start GVRET: "+e.message)}}async stopGVRET(){try{let t=await this.device.execute(`
import gvret
import json
gvret.stop()
print(json.dumps({'success': True, 'status': 'stopped'}))
      `);t&&t.success&&(this.state.gvret.isRunning=!1,this.stopStatsRefresh(),this.state.gvret.stats={rx:0,tx:0,dropped:0},this.emit("render"))}catch(t){console.error("[GVRET] Stop exception:",t)}}startStatsRefresh(){this.stopStatsRefresh(),this.statsInterval=setInterval(()=>{this.state.gvret.isRunning&&this.refreshStats()},2e3),this.refreshStats()}stopStatsRefresh(){this.statsInterval&&(clearInterval(this.statsInterval),this.statsInterval=null)}addFilterUI(){let t=document.getElementById("filter-id-input"),e=document.getElementById("filter-mask-input"),s=document.getElementById("filter-ext-input");if(!t||!e)return;let r=parseInt(t.value,16),n=parseInt(e.value,16),a=s.checked;if(isNaN(r)||isNaN(n)){alert("Invalid ID or Mask (Hex required)");return}this.state.gvret.filters.push({id:r,mask:n,extended:a}),this.applyFilters(),t.value="",this.emit("render")}async clearFilters(){this.state.gvret.filters=[];try{await this.device.execute(`
import gvret
import json
gvret.clear_filters()
print(json.dumps({'success': True}))
      `),this.emit("render")}catch(t){console.error("[GVRET] Clear filters exception:",t)}}async applyFilters(){let t=this.state.gvret;if(t.isRunning)try{let e=`import gvret
import json
gvret.clear_filters()
`;for(let s of t.filters)e+=`gvret.add_filter(${s.id}, ${s.mask}, ${s.extended?"True":"False"})
`;e+=`print(json.dumps({"success": True}))
`,await this.device.execute(e)}catch(e){console.error("[GVRET] Apply filters exception:",e)}}async refreshStats(){let t=this.state.gvret;if(!t.isRunning){t.stats={rx:0,tx:0,dropped:0},this.emit("render");return}try{let e=await this.device.execute(`
import gvret
import json
stats = gvret.get_stats()
print(json.dumps({'success': True, 'rx': stats[0], 'tx': stats[1], 'dropped': stats[2]}))
      `);e&&e.success&&(t.stats.rx=e.rx||0,t.stats.tx=e.tx||0,t.stats.dropped=e.dropped||0,this.emit("render"))}catch(e){let s=e.message?e.message.toLowerCase():String(e).toLowerCase();if(s.includes("not connected")||s.includes("connection")&&s.includes("closed")||s.includes("timeout")){this.stopStatsRefresh();return}console.error("[GVRET] Stats exception:",e)}}render(t){switch(t){case"connection":return this.renderConnection();case"filters":return this.renderFilters();default:return this.html`<div>Unknown panel: ${t}</div>`}}},o=i;export{o as default};

