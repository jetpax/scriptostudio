# Bundle Firmware Workflow
# Merges firmware components (from pyDirect) with VFS device-scripts into deployable .bin files
#
# Triggers:
#   - Push to boards/firmware/components/** (new firmware from pyDirect CI)
#   - Push to boards/firmware/device-scripts/** (VFS content changes)
#   - Manual trigger

name: Bundle Firmware

on:
  push:
    paths:
      - 'boards/firmware/components/**'
      - 'boards/firmware/device-scripts/**'
    branches: [main]
  workflow_dispatch:

jobs:
  bundle:
    name: Build merged firmware
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout scriptostudio
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          # Install mklittlefs
          wget -q https://github.com/earlephilhower/mklittlefs/releases/download/4.1.0/x86_64-linux-gnu-mklittlefs-42acb97.tar.gz
          tar -xzf x86_64-linux-gnu-mklittlefs-42acb97.tar.gz --strip-components=1
          sudo mv mklittlefs /usr/local/bin/
          chmod +x /usr/local/bin/mklittlefs

          # Install esptool
          pip install esptool

      - name: Verify components exist
        run: |
          COMPONENTS="boards/firmware/components"
          if [ ! -d "$COMPONENTS" ] || [ -z "$(ls -A $COMPONENTS 2>/dev/null)" ]; then
            echo "âŒ No firmware components found in $COMPONENTS"
            echo "   Components are pushed by pyDirect CI. Run the pyDirect build first."
            exit 1
          fi
          echo "ðŸ“¦ Found variants:"
          ls -1 "$COMPONENTS"

      - name: Build merged firmware for each variant
        run: |
          COMPONENTS="boards/firmware/components"
          DEVICE_SCRIPTS="boards/firmware/device-scripts"
          FIRMWARE_DIR="boards/firmware"

          for variant_dir in "$COMPONENTS"/*/; do
            VARIANT=$(basename "$variant_dir")
            echo "ðŸ“¦ Processing variant: $VARIANT"

            BOOTLOADER="$variant_dir/bootloader.bin"
            PARTITION_TABLE="$variant_dir/partition-table.bin"
            FIRMWARE="$variant_dir/micropython.bin"
            PARTITION_CSV=$(find "$variant_dir" -name "partitions*.csv" | head -1)

            # Verify all components present
            for f in "$BOOTLOADER" "$PARTITION_TABLE" "$FIRMWARE" "$PARTITION_CSV"; do
              if [ ! -f "$f" ]; then
                echo "âŒ Missing: $f"
                exit 1
              fi
            done

            # Parse VFS partition offset and size from CSV
            VFS_LINE=$(grep "^vfs," "$PARTITION_CSV")
            VFS_OFFSET=$(echo "$VFS_LINE" | cut -d',' -f4 | xargs)
            VFS_SIZE=$(echo "$VFS_LINE" | cut -d',' -f5 | xargs)

            if [[ "$VFS_SIZE" == 0x* ]]; then
              VFS_SIZE=$((VFS_SIZE))
            fi

            echo "  VFS offset: $VFS_OFFSET, size: $VFS_SIZE bytes"

            # Create VFS partition from device-scripts
            VFS_IMAGE="/tmp/vfs-${VARIANT}.bin"
            mklittlefs \
              -c "$DEVICE_SCRIPTS" \
              -b 4096 -p 256 \
              -s "$VFS_SIZE" \
              "$VFS_IMAGE"

            echo "  âœ… VFS image: $(du -h "$VFS_IMAGE" | cut -f1)"

            # Detect chip and flash size from variant name
            CHIP="esp32s3"
            if [[ "$VARIANT" == *"P4"* ]]; then CHIP="esp32p4"; fi

            # Detect flash size from variant suffix (ESP32_S3_8=8MB, ESP32_S3_16=16MB, etc.)
            FLASH_MB=$(echo "$VARIANT" | grep -oE '[0-9]+$')
            FLASH_SIZE="${FLASH_MB}MB"

            # Detect bootloader offset (P4 uses 0x2000, others use 0x0)
            BOOT_OFFSET="0x0"
            if [[ "$CHIP" == "esp32p4" ]]; then
              BOOT_OFFSET="0x2000"
            fi

            # Merge all parts into deployable firmware
            MERGED="$FIRMWARE_DIR/pyDirect-${VARIANT}-merged.bin"
            esptool.py --chip "$CHIP" merge_bin \
              --fill-flash-size "$FLASH_SIZE" \
              --flash_mode dio \
              --flash_freq 80m \
              --flash_size "$FLASH_SIZE" \
              -o "$MERGED" \
              $BOOT_OFFSET "$BOOTLOADER" \
              0x8000 "$PARTITION_TABLE" \
              0x10000 "$FIRMWARE" \
              $VFS_OFFSET "$VFS_IMAGE"

            echo "  âœ… Created: $MERGED ($(du -h "$MERGED" | cut -f1))"
          done

      - name: Update firmware metadata
        run: |
          # Read version from components build-info
          BUILD_INFO="boards/firmware/components/build-info.json"
          if [ -f "$BUILD_INFO" ]; then
            VERSION=$(python3 -c "import json; print(json.load(open('$BUILD_INFO'))['version'])")
            COMMIT=$(python3 -c "import json; print(json.load(open('$BUILD_INFO'))['commit'])")
          else
            VERSION="unknown"
            COMMIT="${{ github.sha }}"
          fi

          cat > boards/firmware/latest.json << EOF
          {
            "version": "$VERSION",
            "updated": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "pyDirect_commit": "$COMMIT",
            "scriptostudio_commit": "${{ github.sha }}",
            "variants": [
              { "id": "ESP32_S3_8", "chip": "esp32s3", "flash": "8MB", "file": "pyDirect-ESP32_S3_8-merged.bin" },
              { "id": "ESP32_S3_16", "chip": "esp32s3", "flash": "16MB", "file": "pyDirect-ESP32_S3_16-merged.bin" },
              { "id": "ESP32_P4_16", "chip": "esp32p4", "flash": "16MB", "file": "pyDirect-ESP32_P4_16-merged.bin" },
              { "id": "ESP32_P4_32", "chip": "esp32p4", "flash": "32MB", "file": "pyDirect-ESP32_P4_32-merged.bin" }
            ]
          }
          EOF

      - name: Commit merged firmware
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add boards/firmware/*.bin boards/firmware/latest.json
          git commit -m "ðŸ¤– Merged firmware $(date -u +%Y-%m-%d)" || echo "No changes"
          git push
