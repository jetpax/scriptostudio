name: Build ScriptO Registry

on:
  push:
    branches: [ main ]
    paths:
      - 'registry/ScriptOs/**'
      - 'registry/Extensions/**'
      - 'boards/manifests/**'
      - 'tools/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install bundler dependencies
      run: npm ci
      working-directory: tools
    
    - name: Bundle Extensions
      run: node bundle_extensions.js --extensions-dir ../registry/Extensions --in-place --verbose
      working-directory: tools
    
    - name: Build index.json
      run: |
        python3 tools/build_index.py \
          --scriptos-dir registry/ScriptOs \
          --extensions-dir registry/Extensions \
          --output registry/index.json \
          --repo-url https://github.com/${{ github.repository }} \
          --branch ${{ github.ref_name }}
    
    - name: Generate ScriptOs HTML catalogue
      run: |
        python3 tools/generate_catalogue.py \
          --index registry/index.json \
          --output registry/catalogue \
          --scriptos-dir registry/ScriptOs
    
    - name: Generate Extensions HTML catalogue
      run: |
        python3 tools/generate_extensions_catalogue.py \
          --index registry/index.json \
          --output registry/extensions-catalogue \
          --extensions-dir registry/Extensions
    
    - name: Commit updated registry
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        git add registry/index.json registry/catalogue registry/extensions-catalogue 'registry/Extensions/**/*.bundle.js'
        git diff --staged --quiet || git commit -m "Build registry from ${{ github.sha }}"
        git push origin main
    
    - name: Output registry URLs
      run: |
        echo ""
        echo "=========================================="
        echo "ScriptO Studio Registry Updated!"
        echo "=========================================="
        echo ""
        echo "Index: https://scriptostudio.com/registry/index.json"
        echo "ScriptOs: https://scriptostudio.com/registry/catalogue/"
        echo "Extensions: https://scriptostudio.com/registry/extensions-catalogue/"
        echo ""
